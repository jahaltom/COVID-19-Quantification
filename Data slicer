import pandas as pd
import os
from os import path


#Import TPM file.
df = pd.read_csv("results_TPM_gene.tsv",sep='\t')
#Import count file.
dfc = pd.read_csv("results_Count_gene.tsv",sep='\t')

#Import list of SRP and SRR IDs.
srr_list = pd.read_csv("list",sep='\t')
##Create dict that has SRP ID as key.
d = srr_list.groupby('SRP')['SRR'].apply(list).to_dict()

##Will be sed to get all genes that pass TPM filter. 
genes=[]

for key in d:
    #quant will be df of all SRR IDs and their TPM. Each Key is a single SRP ID.
    quant = df[d[key]]
    #count will be df of all SRR IDs and their count. Each Key is a single SRP ID.
    count = dfc[d[key]]
    #Metadata from TPM file. Same as count.
    metadata = df[df.columns[0:7]]
    ##Merge metadata with quant and count
    result = pd.concat([metadata, quant], axis=1)
    result_count = pd.concat([metadata, count], axis=1)
    if path.exists(key) is not True:
        os.mkdir(key)
    
    #create a median column
    result['median']=result.median(axis=1)

    indexNames = result[ (result['median'] < 1) & (result['chr'] != 'SARSCOV2_ASM985889v3') ].index
    result.drop(indexNames , inplace=True)

    #calculate medians of median tx tpm dist for protein_coding and lncRNA
    med_med_pc=result.loc[result['Gene_type'] == 'protein_coding']['median'].median()
    med_med_lnc=result.loc[result['Gene_type'] == 'lncRNA']['median'].median()
    med_med_eb=result.loc[result['Gene_type'] == 'EB_novel']['median'].median()

    indexNames = result[(result['Gene_type'] == 'EB_novel') & (result['median'] < med_med_lnc) ].index
    result.drop(indexNames , inplace=True)

    result.to_csv(key +'/'+ key + ".TPM.tsv",sep='\t',index=False)
    result_count.to_csv(key +'/'+ key + ".Count.tsv",sep='\t',index=False)
    ##Append genes to list
    genes.append(result['Gene_stable_ID'])
print(genes)
    



